---
title: "Python ã§ãƒªãƒˆãƒ©ã‚¤å‡¦ç†ã®ãƒ†ã‚¹ãƒˆã‚’æ›¸ã (pytest)"
emoji: "ğŸ"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["pytest", "python"]
published: false
---

Python ã§ãƒªãƒˆãƒ©ã‚¤å‡¦ç†ã‚’æ›¸ã„ãŸã®ã§ãƒ¡ãƒ¢ã€‚

## ãƒ†ã‚¹ãƒˆå¯¾è±¡ã®ã‚³ãƒ¼ãƒ‰

target.py
```python
class ApiConnectionError(Exception):
    pass


class Target:

    def get(self, key: str) -> dict[str, str]:
        """api ã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã™ã‚‹å‡¦ç†

        Args:
            key (str): API ãƒ‘ã‚¹ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãƒ¼

        Returns:
            dict[str, str]: API ãƒ¬ã‚¹ãƒãƒ³ã‚¹

        Note:
            API é€šä¿¡ã«å¤±æ•—ã™ã‚‹ã¨
            ApiConnectionError ã‚’é€å‡ºã—ã¾ã™
        """        
        # key ã‚’ä½¿ã£ã¦ api ã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã™ã‚‹å‡¦ç†ãŒæ›¸ã‹ã‚Œã¦ã„ã‚‹
        return {"get": "data"}
    
    def retry_get(self, key: str) -> dict[str, str]:
        """1å›ã ã‘ self.get ã‚’ãƒªãƒˆãƒ©ã‚¤ã™ã‚‹é–¢æ•°

        Args:
            key (str): API ãƒ‘ã‚¹ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãƒ¼

        Returns:
            dict[str, str]: API ãƒ¬ã‚¹ãƒãƒ³ã‚¹
        """        
        try:
            return self.get(key)
        except ApiConnectionError:
            return self.get(key)

```

ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ§‹æˆã¯ä»¥ä¸‹ã®ã‚ˆã†ã«ãªã£ã¦ã„ã¾ã™ã€‚

```shell
â¯ tree --gitignore
.
â”œâ”€â”€ target
â”‚   â”œâ”€â”€ __init__.py
â”‚   â””â”€â”€ target.py
â””â”€â”€ tests
    â”œâ”€â”€ __init__.py
    â””â”€â”€ test_target.py
```

## pytest ã§ã®ãƒ†ã‚¹ãƒˆ

retry_get ã¯ get ã‚’1å›ã ã‘ãƒªãƒˆãƒ©ã‚¤ã™ã‚‹ã®ã§ã€ApiConnectionError ãŒç™ºç”Ÿã—ãŸã¨ãã« get ãŒæœ¬å½“ã«2å›å®Ÿè¡Œã•ã‚Œã¦ã„ã‚‹ã‹ã‚’ãƒ†ã‚¹ãƒˆã—ã¾ã™ã€‚

test_target.py
```python
from unittest import mock

import pytest

class TestTarget:

    def test_retry_execute(self):
        """get ãŒ 2å›å‘¼ã°ã‚Œã‚‹ã“ã¨ã‚’ãƒ†ã‚¹ãƒˆã™ã‚‹
        """        
        from target.target import Target, ApiConnectionError

        t = Target()
        # get ãŒ ApiConnectionError ã‚’é€å‡ºã™ã‚‹ã‚ˆã†ã«ãƒ¢ãƒƒã‚¯
        t.get = mock.Mock(side_effect=ApiConnectionError)

        with pytest.raises(ApiConnectionError):
            t.retry_get("test")

        assert t.get.call_count == 2

```

t.get ã« ApiConnectionError ã‚’é€å‡ºã—ã¦ã‚‚ã‚‰ã„ãŸã„ã®ã§ã€ `Mock(side_effect=ApiConnectionError)` ã®ã‚ˆã†ã«ãƒ¢ãƒƒã‚¯ã—ã¾ã™ã€‚
side_effect ã«ã¤ã„ã¦ã¯ [unittest.mock --- å…¥é–€ ](https://docs.python.org/ja/3.9/library/unittest.mock-examples.html#raising-exceptions-with-mocks) ã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚

æ¬¡ã« t.get ãŒä¾‹å¤–ã‚’é€å‡ºã™ã‚‹ã‚ˆã†ã«ãƒ¢ãƒƒã‚¯ã—ãŸã®ã§ã€t.retry_get ã‚‚ä¾‹å¤–ã‚’é€å‡ºã™ã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚
ã“ã“ã§ã€pytest.raises() ã‚’ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆãƒãƒãƒ¼ã‚¸ãƒ£ã¨ã—ã¦åˆ©ç”¨ã—ã¦ t.retry_get ã‚’å®Ÿè¡Œã—ã¾ã™ã€‚

æœ€å¾Œã« t.get (Mock) ãŒå‘¼ã°ã‚ŒãŸå›æ•°ã‚’ call_count å±æ€§ã‚’ä½¿ã£ã¦æ¤œè¨¼ã—ã¾ã™ã€‚

pytest ã‚’å®Ÿè¡Œã—æˆåŠŸã™ã‚Œã°å®Ÿéš›ã« t.get ãŒ2å›å®Ÿè¡Œã•ã‚ŒãŸã“ã¨ãŒæ¤œè¨¼ã§ãã¾ã™ï¼

## ãŠã‚ã‚Šã«

ã‚‚ã£ã¨è‰¯ã„ã‚„ã‚Šæ–¹ãªã©ã‚ã‚‹ã¨ã„ã†æ–¹ãŒã„ã¾ã—ãŸã‚‰ãœã²æ•™ãˆã¦ãã ã•ã„ï¼

ã“ã“ã¾ã§èª­ã‚“ã§ãã‚Œã¦ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã—ãŸã€‚

